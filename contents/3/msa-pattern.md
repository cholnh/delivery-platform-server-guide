# MSA 패턴

<br/><br/>



## :speech_balloon: 개요
앞에서 설명한 아키텍처는 문제 영역에 대한 솔루션을 제공하는 것입니다.  
그렇다면 어떤 문제영역이 있고 어떤 해법으로 그 문제를 해결할까요?  

<br/>

이처럼 어떤 문제 영역에 대해 여러 사람들에 의해 검증되어 정리된 유용한 해법을 패턴(Pattern)이라고 합니다.  
MSA 에도 이러한 설계 패턴들이 존재합니다.  

<br/>

MSA 를 통해 서비스를 제공하려면 우선은 인프라가 구축돼야 하고,  
그 위에 미들웨어가 올라가고, 미들웨어 위에서 어플리케이션이 동작해야 합니다.  

|패턴 유형|설명|
|-|-|
|인프라 구성요소|마이크로 서비스를 지탱하는 하부구조 인프라를 구축하는 데 필요한 구성요소|
|플랫폼 패턴|인프라 위에서 마이크로 서비스의 운영과 관리를 지원하는 플랫폼 차원의 패턴|
|어플리케이션 패턴|마이크로 서비스 어플리케이션을 구성하는 데 필요한 패턴|

<br/>

마이크로 서비스가 동작하고 운영되는 그릇인 외부 아키텍처를 중심으로, 시스템의 기반을 지탱하는 인프라 구성 요소부터 살펴보겠습니다.

<br/><br/>

## 인프라 구성요소
인프라란 엔터프라이즈 IT 환경을 운영/관리하는 데 필요한 근간이 되는
- 하드웨어
- 소프트웨어
- 네트워크 구성요소
- 운영체제
- 데이터 스토리지 등

을 모두 포괄하는 영역입니다.

<br/>

> 클라우드 환경에서는 이러한 인프라 구성요소가 가상화되어 제공됩니다.

<br/><br/>

### 클라우드 환경
예전에 오랜 시간에 걸쳐 힘들게 구축했던 인프라를 이제는 AWS, 구글, 마이크로소프트, IBM 등 세계적인 플랫폼 사업자들이 
자동화된 Iaas (Infrastructure as a Service), Paas (Platform as a Service) 서비스를 통해 쉽고 편하게 이용할 수 있게 해줍니다.

<br/>

시스템의 자원 구성, 할당, 관리, 모니터링 등의 설정작업을 몇 번의 클릭만으로 가능하게 합니다.  
하지만 클라우드 환경에서도 아키텍트가 고려해야 할 일들은 여러가지가 있습니다.  

- 하부 시스템의 기반이 되는 인프라 구축
- 베어 메탈 장비에 인프라를 구축할지, 가상화 환경을 선택할지 결정
- 가상화 환경에서 퍼블릭 Iaas, PaaS 를 선택할지, 직접 구매할지, 베어 메탈 서버에 프라이빗 PaaS 를 구축할지 결정

<br/>

마이크로 서비스는 어떠한 장비에도 구동될 수 있습니다.  
그렇지만 가상화 장치 없이 구동한다면 인프라의 유연한 확장/축소를 기대하기 힘든 무모한 작업이 됩니다.  
(MSA 시스템을 위한 베어 메탈을 고려한다면 그것은 베어 메탈에 별도의 프라이빗 클라우드 환경을 구축하는 것을 의미합니다)  
따라서 MSA 는 가상 인프라 환경을 환경을 이용하는 것이 효율적입니다.  

<br/>

인프라를 선택하였다면, 다음으로 가상머신과 컨테이너 기반 제품을 고민해보겠습니다.

### VM과 컨테이너
두 기술 모두 가상의 공간을 만들어내는 공통점이 있습니다.  
하지만 자세하게 살펴보면 완전히 다른 점들이 있습니다.  

- 가상머신(VM; Virtual Machine)  
    하이퍼바이저(Hypervisor)라는 소프트웨어를 이용해 하나의 시스템에서 여러 개의 OS(운영체제)를 사용하는 기술  
    + 일반적으로 크기가 기가바이트 단위
    + 게스트 OS 를 사용하기에 OS 패치 설치, 라이브러리 설치 등 오버헤드가 지속적으로 발생
    
<br/>
    
- 컨테이너  
    하이퍼바이저 없이 컨테이너 엔진을 사용해 가상의 격리된 공간을 생성  
    + 일반적으로 크기가 메가바이트 단위
    + 작은 서비스를 패키징하고 배포하기에 적합 (실행에 필요한 모든 파일이 컨테이너에 패키징 되지 않음)

<br/>

|<img src="https://github.com/cholnh/delivery-platform-server-guide/blob/main/assets/images/3/msa-pattern-vm-container.png" width="600"/>|
|-|
|그림 1 - 가상 머신과 컨테이너|

MSA 에서는 작은 서비스 단위로 잦은 배포가 이루어지므로 컨테이너 환경이 유리합니다.  
마이크로 서비스의 가변적이고 유연한 속성을 컨테이너가 쉽고 빠르게 지원할 수 있기 때문입니다.  
가장 대표적인 컨테이너 기술로는 도커가 있습니다.
도커에 관한 설명은 [이곳을](https://github.com/cholnh/delivery-platform-server-guide/blob/main/contents/3/msa-docker.md#도커) 참조해주세요.

<br/><br/>

### 컨테이너 오케스트레이션
도커 외에도 Unikernels, LXD, OpenVZ, RKt 등 컨테이너 기술들이 있습니다.  
컨테이너 기술을 선택하셨다면 컨테이너를 관리하기 위한 기술 또한 필요합니다.  

<br/>

#### 왜 필요한가?
컨테이너가 많아지면 그에 따른 관리가 필연적입니다.  
- 컨테이너의 자동 배치 및 복제
- 컨테이너 장애 복구
- 컨테이너 확장 및 축소
- 컨테이너 간 통신 관리
- 로드 밸런싱 등

이 밖에도 여러 필요에 따른 관리 기술들이 필요해집니다.  

<br/>

이러한 컨테이너 관리 기술을 통틀어 컨테이너 오케스트레이션 이라 합니다.  
오케스트레이션 도구로는 Docker Swarm, Apache Mesos,  
그리고 최근 구글이 자사의 도커 컨테이너 관리 노하우를 바탕으로 만든 Kubernetes 가 있습니다.  
쿠버네티스에 관한 설명은 [이곳을](https://github.com/cholnh/delivery-platform-server-guide/blob/main/contents/3/msa-kubernetes.md#쿠버네티스) 참조해주세요.

<br/><br/>

### 클라우드 인프라 서비스
클라우드 인프라 선택지는 매우 다양합니다.  
위 클라우드 환경에서 설명하였듯이 여러 사업자들이 많은 인프라 시스템을 제공합니다.  
- AWS
- Azure
- Google Cloud 등

<br/>

MSA 시스템으로 간다고 하면 쿠버네티스는 아니지만 동일하게 컨테이너 기반인
- AWS Elastic Beanstalk
- Elastic Container Service(ECS)
- Azure Web App
- Google App Engine 등
여러 PaaS 를 고려할 수 있습니다.

> PaaS(Platform as a Service) : 복잡함 없이 어플리케이션을 곧바로 개발, 실행, 관리할 수 있는 플랫폼 환경을 서비스 형태로 제공합니다. 
> IaaS 위에 미들웨어나 런타임까지 탑재된 환경이라 생각하면 됩니다.

<br/>

여기까지 마이크로 서비스를 적재하기 위한 기반이 되는 클라우드 인프라 요소를 살펴보았습니다.  
다음으로는 마이크로 서비스의 원활한 동작을 지원하는 플랫폼 환경을 살펴보겠습니다.

<br/><br/>

## 플랫폼 패턴
인프라 환경 위에서 어플리케이션을 운영/관리/빌드/배포하는 환경을 구성하는 방법을 생각해봐야 합니다.  

> 마틴 파울러가 강조했듯이 MSA 시스템을 구성하는 수많은 마이크로 서비스를 하나하나 수동으로 빌드/배포한다면 엄청나게 비효율적입니다. 
> 이러한 과정을 하나하나 통제하고 자동화하는 것이 중요합니다.

<br/><br/>

### 데브옵스 인프라 구성
마이크로 서비스를 (자동으로) 빌드하고 테스트한 뒤 배포할 수 있게 도와주는 개발 지원 환경을 데브옵스(DevOps)환경이라 합니다.
(보통 개발+운영 을 병행하는 조직 또는 문화를 뜻하는데, 여기서는 자동화 환경의 의미로 사용하겠습니다)

<br/>

과거 수동 빌드/배포 과정은 매우 많은 시간이 소요되었습니다.  
또한 배포 때마다 시스템을 중단한 뒤 배포 작업을 진행하는 경우가 많았습니다.  
하지만 MSA 환경에서는 잦은 배포가 이루어져야 하므로 배포의 자동화와 무중단 배포가 절실합니다.

<br/>

자동화된 빌드/배포 작업은 CI/CD 라 합니다.  
- CI (Continuous Integration; 지속적 통합)  
    오랜 시간이 걸리는 빌드를 자동화하여 개발 생산성과 소스코드 품질을 높입니다.  
    자동으로 통합 및 테스트하고 그 결과를 리포트로 기록합니다.
    
    |<img src="https://github.com/cholnh/delivery-platform-server-guide/blob/main/assets/images/3/msa-pattern-cicd.png" width="700"/>|
    |-|
    |그림 2 - 자동 빌드 및 배포 절차|
    
<br/>
    
- CD (Continuous Deployment; 지속적 배포)  
    소스코드 저장소에서 빌드한 소스코드의 실행 파일을 실행 환경까지 자동으로 배포하는 방식을 뜻합니다.  
    
    

